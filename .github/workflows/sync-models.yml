name: Sync Models from Google Sheets

on:
  # 1. –ü–æ —Ä–∞—Å–ø–∏—Å–∞–Ω–∏—é (–∫–∞–∂–¥—ã–π –¥–µ–Ω—å –≤ 3:00 UTC)
  schedule:
    - cron: '0 3 * * *'  # –ï–∂–µ–¥–Ω–µ–≤–Ω–æ –≤ 03:00
  
  # 2. –†—É—á–Ω–æ–π –∑–∞–ø—É—Å–∫ –∏–∑ –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å–∞ GitHub
  workflow_dispatch:
  
  # 3. –ü—Ä–∏ –ø—É—à–µ –≤ main –≤–µ—Ç–∫—É (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ)
  push:
    branches:
      - main
    paths:
      - 'scripts/**'
      - '.github/workflows/**'

# –†–∞–∑—Ä–µ—à–∞–µ–º –∑–∞–ø–∏—Å—å –≤ —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏–π
permissions:
  contents: write

jobs:
  sync-models:
    runs-on: ubuntu-latest
    
    steps:
    # 1. –ö–ª–æ–Ω–∏—Ä—É–µ–º —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏–π
    - name: Checkout repository
      uses: actions/checkout@v4
      with:
        token: ${{ secrets.GITHUB_TOKEN }}
        
    # 2. –ù–∞—Å—Ç—Ä–∞–∏–≤–∞–µ–º Node.js
    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '18'
        cache: 'npm'
        
    # 3. –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏
    - name: Install dependencies
      run: |
        cd scripts
        npm init -y
        npm install google-spreadsheet@^3.3.0 axios@^1.6.0
        
    # 4. –ó–∞–ø—É—Å–∫–∞–µ–º —Å–∫—Ä–∏–ø—Ç —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏–∏
    - name: Run sync script
      env:
        GOOGLE_SHEET_ID: ${{ secrets.GOOGLE_SHEET_ID }}
        GOOGLE_SERVICE_ACCOUNT_JSON: ${{ secrets.GOOGLE_SERVICE_ACCOUNT_JSON }}
        YANDEX_DISK_FOLDER: ${{ secrets.YANDEX_DISK_FOLDER }}
      run: |
        cd scripts
        node sync-models.js
        
    # 5. –ö–æ–º–º–∏—Ç–∏–º –∏–∑–º–µ–Ω–µ–Ω–∏—è, –µ—Å–ª–∏ –æ–Ω–∏ –µ—Å—Ç—å
    - name: Commit and push changes
      run: |
        git config --global user.name 'GitHub Actions Bot'
        git config --global user.email 'actions@github.com'
        
        # –ü—Ä–æ–≤–µ—Ä—è–µ–º, –µ—Å—Ç—å –ª–∏ –∏–∑–º–µ–Ω–µ–Ω–∏—è
        if [[ -n $(git status --porcelain) ]]; then
          git add data/
          git add photos/ 2>/dev/null || true
          git commit -m "ü§ñ Auto-update: $(date '+%Y-%m-%d %H:%M')"
          git push
          echo "‚úÖ Changes committed and pushed"
        else
          echo "‚ö†Ô∏è No changes to commit"
        fi
        
    # 6. –£–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ –æ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–µ (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ)
    - name: Notify on success
      if: success()
      run: |
        echo "‚úÖ Sync completed successfully at $(date)"
        
    - name: Notify on failure
      if: failure()
      run: |
        echo "‚ùå Sync failed at $(date)"
        exit 1
